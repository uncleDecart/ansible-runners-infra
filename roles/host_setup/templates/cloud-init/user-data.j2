#cloud-config
password: password
chpasswd:
  expire: False

write_files:
  - path: /home/ubuntu/connect-runner.sh
    permissions: '0755'
    encoding: b64
    content: |
      {{ encoded_script }}
  - path: /etc/docker/daemon.json
    owner: root:root
    permissions: '0644'
    content: |
      {
        "insecure-registries": {{ github_runner.docker_insecure_registries | to_json }}
      }
  - path: /usr/local/share/ca-certificates/localreg.crt
    ownder: root:rott
    permissions: '0644'
    content: |
      -----BEGIN CERTIFICATE-----
      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
      NTJMNUpoyAVm4PGjMnr59uPRow6TNw==
      -----END CERTIFICATE-----

package_update: true
package_upgrade: true
packages:
  - jq
  - build-essential
  - curl
  - git
  - make
  - snapd
  - binfmt-support
  - qemu
  - qemu-utils
  - qemu-system-x86
  - qemu-guest-agent
  - qemu-user-static
  - qemu-system-aarch64
  - qemu-system-misc

snap:
  commands:
    - snap install go --classic

runcmd:
  - chown ubuntu:ubuntu /home/ubuntu/
  - usermod -aG kvm ubuntu
  - usermod -aG docker ubuntu
  - newgrp docker
  - update-ca-certificates
  - sudo -u ubuntu -i -- bash /home/ubuntu/connect-runner.sh
